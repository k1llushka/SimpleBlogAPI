name: Blog API Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ ÑĞ±Ğ¾Ñ€ĞºĞ°
  build-and-test:
    name: ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    runs-on: windows-latest

    steps:
    - name: ğŸ“¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ´
      uses: actions/checkout@v4

    - name: ğŸ“ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
      shell: pwsh
      run: |
        Write-Host "ğŸ“ Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: $(pwd)" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "ğŸ“ ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°:" -ForegroundColor Cyan
        Get-ChildItem -Recurse | Where-Object { $_.Name -match '\.(csproj|sln)$' } | ForEach-Object {
          Write-Host "  â€¢ $($_.FullName)" -ForegroundColor Gray
        }

    - name: âš™ï¸ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“¦ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
      shell: pwsh
      run: |
        Write-Host "ğŸ“¦ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸..." -ForegroundColor Green
        
        # Ğ˜Ñ‰ĞµĞ¼ Ğ²ÑĞµ csproj Ñ„Ğ°Ğ¹Ğ»Ñ‹
        $projFiles = Get-ChildItem -Recurse -Filter *.csproj
        if ($projFiles.Count -gt 0) {
          Write-Host "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹:" -ForegroundColor Green
          foreach ($proj in $projFiles) {
            Write-Host "  ğŸ“¦ $($proj.FullName)" -ForegroundColor Gray
            dotnet restore $proj.FullName
          }
        } else {
          Write-Host "âŒ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹!" -ForegroundColor Red
          exit 1
        }

    - name: ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ (ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ«Ğ™ Ğ’ĞĞ Ğ˜ĞĞĞ¢)
      shell: pwsh
      run: |
        Write-Host "ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚..." -ForegroundColor Green
        
        # Ğ’ĞĞ Ğ˜ĞĞĞ¢ 1: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚
        $mainProject = Get-ChildItem -Recurse -Filter *.csproj | Where-Object { $_.Name -match 'SimpleBlog\.API' } | Select-Object -First 1
        
        if ($mainProject) {
          Write-Host "ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°: $($mainProject.FullName)" -ForegroundColor Cyan
          dotnet build $mainProject.FullName --configuration Release --no-restore
        } else {
          # Ğ’ĞĞ Ğ˜ĞĞĞ¢ 2: Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ²ÑĞµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹ Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ğ°Ğ¿ĞºĞ¸
          Write-Host "ğŸ”¨ Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ²ÑĞµÑ… Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¾Ğ² Ğ² Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ğ°Ğ¿ĞºĞµ..." -ForegroundColor Cyan
          Get-ChildItem -Filter *.csproj | ForEach-Object {
            Write-Host "  ğŸ”¨ Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ $($_.Name)..." -ForegroundColor Gray
            dotnet build $_ --configuration Release --no-restore
          }
        }
        
        Write-Host "âœ… Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°!" -ForegroundColor Green

    - name: ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸
      shell: pwsh
      run: |
        Write-Host "ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ ÑĞ±Ğ¾Ñ€ĞºĞ¸..." -ForegroundColor Cyan
        
        # Ğ˜Ñ‰ĞµĞ¼ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        $buildOutputs = Get-ChildItem -Recurse -Path "bin" -Filter *.dll -ErrorAction SilentlyContinue
        if ($buildOutputs.Count -gt 0) {
          Write-Host "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ ÑĞ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹:" -ForegroundColor Green
          $buildOutputs | Group-Object Directory | ForEach-Object {
            Write-Host "  ğŸ“ $($_.Name)" -ForegroundColor Gray
            $_.Group | Select-Object -First 3 | ForEach-Object {
              Write-Host "    â€¢ $($_.Name)" -ForegroundColor DarkGray
            }
            if ($_.Count -gt 3) { Write-Host "    â€¢ ... Ğ¸ ĞµÑ‰Ğµ $($_.Count - 3) Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²" -ForegroundColor DarkGray }
          }
        } else {
          Write-Host "âš ï¸ Ğ¡Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹" -ForegroundColor Yellow
        }

    - name: ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹
      shell: pwsh
      run: |
        Write-Host "ğŸ§ª Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹..." -ForegroundColor Green
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
        New-Item -ItemType Directory -Force -Path TestResults | Out-Null
        
        # Ğ˜Ñ‰ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹
        $testProjects = Get-ChildItem -Recurse -Filter *.csproj | 
                        Where-Object { $_.Name -match "Test" }
        
        if ($testProjects.Count -gt 0) {
          Write-Host "âœ… ĞĞ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹:" -ForegroundColor Green
          
          foreach ($testProj in $testProjects) {
            Write-Host ""
            Write-Host "ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚: $($testProj.Name)" -ForegroundColor Cyan
            Write-Host "  ğŸ“ ĞŸÑƒÑ‚ÑŒ: $($testProj.FullName)" -ForegroundColor Gray
            
            # Unit Ñ‚ĞµÑÑ‚Ñ‹
            Write-Host "  ğŸ”¹ Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ unit-Ñ‚ĞµÑÑ‚Ñ‹..." -ForegroundColor Gray
            dotnet test $testProj.FullName `
              --verbosity normal `
              --logger "trx;LogFileName=$($testProj.BaseName)-unit.trx" `
              --results-directory TestResults `
              --no-restore `
              --filter "Category!=Integration"
            
            # Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹
            Write-Host "  ğŸ”— Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹..." -ForegroundColor Gray
            dotnet test $testProj.FullName `
              --verbosity normal `
              --filter "Category=Integration" `
              --logger "trx;LogFileName=$($testProj.BaseName)-integration.trx" `
              --results-directory TestResults `
              --no-restore
          }
          
          Write-Host "âœ… Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!" -ForegroundColor Green
        } else {
          Write-Host "âš ï¸ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹" -ForegroundColor Yellow
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºÑƒ
          "<TestRun></TestRun>" | Out-File -FilePath "TestResults/no-tests.trx"
        }

    - name: ğŸ“Š Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          **/bin/Release/
          TestResults/
        retention-days: 7

  # Ğ”Ğ¶Ğ¾Ğ±Ğ° 2: ĞÑ‚Ñ‡ĞµÑ‚
  report:
    name: ğŸ“Š ĞÑ‚Ñ‡ĞµÑ‚ Ğ¾ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸
    needs: build-and-test
    runs-on: windows-latest
    if: always()

    steps:
    - name: ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚
      shell: pwsh
      run: |
        $status = '${{ needs.build-and-test.result }}'
        $statusColor = if ($status -eq 'success') { 'Green' } else { 'Red' }
        
        Write-Host ""
        Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
        Write-Host "â•‘                 ĞĞ¢Ğ§Ğ•Ğ¢ Ğ Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ˜Ğ˜ CI/CD                 â•‘" -ForegroundColor Cyan
        Write-Host "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£" -ForegroundColor Cyan
        Write-Host "â•‘                                                          â•‘" -ForegroundColor Cyan
        Write-Host "â•‘  ğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡: " -NoNewline -ForegroundColor Cyan
        Write-Host "$status" -ForegroundColor $statusColor
        Write-Host "â•‘                                                          â•‘" -ForegroundColor Cyan
        Write-Host "â•‘  ğŸ“ Ğ’ĞµÑ‚ĞºĞ°: ${{ github.ref }}" -ForegroundColor Gray
        Write-Host "â•‘  ğŸ”– ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚: ${{ github.sha }}" -ForegroundColor Gray
        Write-Host "â•‘  ğŸ‘¤ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ‚Ğ¾Ñ€: ${{ github.actor }}" -ForegroundColor Gray
        Write-Host "â•‘  ğŸ’» Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ°: Windows" -ForegroundColor Gray
        Write-Host "â•‘                                                          â•‘" -ForegroundColor Cyan
        Write-Host "â•‘  ğŸ• Ğ’Ñ€ĞµĞ¼Ñ: $(Get-Date -Format 'HH:mm:ss dd.MM.yyyy')" -ForegroundColor Gray
        Write-Host "â•‘                                                          â•‘" -ForegroundColor Cyan
        
        if ($status -eq 'success') {
          Write-Host "â•‘  ğŸ‰ Ğ’Ğ¡Ğ• Ğ­Ğ¢ĞĞŸĞ« Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ« Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!                    â•‘" -ForegroundColor Green
          Write-Host "â•‘  ğŸ“¦ ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ğ´Ğ»Ñ ÑĞºĞ°Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ               â•‘" -ForegroundColor Cyan
        } else {
          Write-Host "â•‘  âŒ ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•ĞĞ« ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ«!                              â•‘" -ForegroundColor Red
          Write-Host "â•‘  âš ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ                        â•‘" -ForegroundColor Yellow
        }
        
        Write-Host "â•‘                                                          â•‘" -ForegroundColor Cyan
        Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
        Write-Host ""