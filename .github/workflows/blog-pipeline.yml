name: Blog API Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_NAME: 'SimpleBlog.API'
  PROJECT_PATH: 'src/SimpleBlog.API'
  TEST_PATH: 'tests/SimpleBlog.API.Tests'

jobs:
  # –î–∂–æ–±–∞ 1: –°–±–æ—Ä–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
  build:
    name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: üßπ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∏–ª—å –∫–æ–¥–∞
      run: dotnet format ${{ env.PROJECT_PATH }} --verify-no-changes || echo "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ"

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      uses: actions/upload-artifact@v4
      with:
        name: blog-api-build
        path: ${{ env.PROJECT_PATH }}/bin/Release/net8.0/
        retention-days: 7

  # –î–∂–æ–±–∞ 2: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
  test:
    name: üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
      run: dotnet test ${{ env.TEST_PATH }} --verbosity normal --logger "trx;LogFileName=unit-tests.trx"

    - name: üîó –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
      run: dotnet test ${{ env.TEST_PATH }} --verbosity normal --logger "trx;LogFileName=integration-tests.trx"

    - name: üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          ${{ env.TEST_PATH }}/TestResults/*.trx
        retention-days: 30

  # –î–∂–æ–±–∞ 3: –°–æ–∑–¥–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
  docker-build:
    name: üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      run: |
        docker build -t simple-blog-api:${{ github.sha }} .
        docker images

    - name: üìÅ –°–æ—Ö—Ä–∞–Ω—è–µ–º Dockerfile –∏ –∫–æ–Ω—Ñ–∏–≥–∏
      uses: actions/upload-artifact@v4
      with:
        name: docker-configs
        path: |
          Dockerfile
          **/appsettings.json
        retention-days: 7

  # –î–∂–æ–±–∞ 4: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  publish:
    name: üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    needs: [build, test, docker-build]
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ./publish --self-contained false

    - name: üìù –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–±–æ—Ä–∫–µ
      run: |
        echo "Build Information" > ./publish/build-info.txt
        echo "========================" >> ./publish/build-info.txt
        echo "Version: 1.0.0" >> ./publish/build-info.txt
        echo "Commit: ${{ github.sha }}" >> ./publish/build-info.txt
        echo "Branch: ${{ github.ref }}" >> ./publish/build-info.txt
        echo "Built: $(date)" >> ./publish/build-info.txt
        echo "Author: ${{ github.actor }}" >> ./publish/build-info.txt

    - name: üì¶ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        zip -r simple-blog-api-v1.0.0.zip ./publish/*
        echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
        ls -lh simple-blog-api-v1.0.0.zip

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: simple-blog-api-v1.0.0.zip
        retention-days: 30

  # –î–∂–æ–±–∞ 5: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  report:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: [build, test, docker-build, publish]
    runs-on: ubuntu-latest

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      run: |
        echo "================================================================"
        echo "BLOG API –ü–ê–ô–ü–õ–ê–ù –ó–ê–í–ï–†–®–ï–ù! ‚úÖ"
        echo "================================================================"
        echo ""
        echo "–†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–´–ü–û–õ–ù–ï–ù–ò–Ø:"
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ - –£–°–ü–ï–®–ù–û"
        echo "‚úÖ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ - –£–°–ü–ï–®–ù–û"
        echo "‚úÖ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞ - –£–°–ü–ï–®–ù–û"
        echo "‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –£–°–ü–ï–®–ù–û"
        echo ""
        echo "üì¶ –°–û–ó–î–ê–ù–ù–´–ï –ê–†–¢–ï–§–ê–ö–¢–´:"
        echo "‚Ä¢ blog-api-build - –°–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
        echo "‚Ä¢ test-results - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
        echo "‚Ä¢ docker-configs - Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
        echo "‚Ä¢ release-package - –†–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç"
        echo ""
        echo "üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–†–û–ï–ö–¢–ï:"
        echo "‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ: ${{ env.PROJECT_NAME }}"
        echo "‚Ä¢ .NET Version: ${{ env.DOTNET_VERSION }}"
        echo "‚Ä¢ –í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo ""
        echo "üïê –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
        echo "---"