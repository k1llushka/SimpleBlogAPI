name: Blog API Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'SimpleBlogAPI.sln'

jobs:
  # –î–∂–æ–±–∞ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–±–æ—Ä–∫–∞
  build-and-test:
    name: üî® –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    runs-on: windows-latest  # –ò—Å–ø–æ–ª—å–∑—É–µ–º Windows runner

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: üìÅ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      shell: pwsh
      run: |
        Write-Host "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(Get-Location)" -ForegroundColor Cyan
        Write-Host "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:" -ForegroundColor Cyan
        Get-ChildItem -Force
        Write-Host ""
        Write-Host "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ src/:" -ForegroundColor Cyan
        Get-ChildItem -Path src -Force -ErrorAction SilentlyContinue
        Write-Host ""
        Write-Host "üìÅ –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Filter *.csproj | ForEach-Object { Write-Host "  - $($_.FullName)" }
        Write-Host ""
        Write-Host "üìÅ –§–∞–π–ª—ã —Ä–µ—à–µ–Ω–∏—è:" -ForegroundColor Cyan
        Get-ChildItem -Filter *.sln

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      shell: pwsh
      run: |
        Write-Host "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..." -ForegroundColor Green
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ solution —Ñ–∞–π–ª–∞
        if (Test-Path ${{ env.SOLUTION_FILE }}) {
          Write-Host "‚úÖ –ù–∞–π–¥–µ–Ω solution —Ñ–∞–π–ª: ${{ env.SOLUTION_FILE }}" -ForegroundColor Green
          dotnet restore ${{ env.SOLUTION_FILE }}
        } else {
          Write-Host "‚ö†Ô∏è Solution —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º .csproj —Ñ–∞–π–ª—ã" -ForegroundColor Yellow
          
          # –ò—â–µ–º –≤—Å–µ csproj —Ñ–∞–π–ª—ã
          $projFiles = Get-ChildItem -Recurse -Filter *.csproj
          if ($projFiles.Count -gt 0) {
            Write-Host "‚úÖ –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ–µ–∫—Ç—ã:" -ForegroundColor Green
            $projFiles | ForEach-Object { Write-Host "  - $($_.Name)" }
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç
            foreach ($proj in $projFiles) {
              Write-Host "üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º $($proj.Name)..." -ForegroundColor Cyan
              dotnet restore $proj.FullName
            }
          } else {
            Write-Host "‚ùå –§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!" -ForegroundColor Red
            exit 1
          }
        }

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      shell: pwsh
      run: |
        Write-Host "üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..." -ForegroundColor Green
        
        if (Test-Path ${{ env.SOLUTION_FILE }}) {
          Write-Host "üî® –°–±–æ—Ä–∫–∞ solution..." -ForegroundColor Cyan
          dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore
        } else {
          Write-Host "üî® –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤..." -ForegroundColor Cyan
          dotnet build --configuration Release --no-restore
        }
        
        Write-Host "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!" -ForegroundColor Green
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏
        Write-Host ""
        Write-Host "üìÅ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–∫–∏:" -ForegroundColor Cyan
        Get-ChildItem -Recurse -Path "bin\Release" -Filter *.dll -ErrorAction SilentlyContinue | 
          Select-Object -First 10 Name, Directory |
          ForEach-Object { Write-Host "  - $($_.Name) –≤ $($_.Directory)" }

    - name: üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
      shell: pwsh
      run: |
        Write-Host "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..." -ForegroundColor Green
        
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
        New-Item -ItemType Directory -Force -Path TestResults | Out-Null
        
        # –ò—â–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
        $testProjects = Get-ChildItem -Recurse -Filter *.csproj | 
                        Where-Object { $_.Name -match "Test" -or $_.Directory.Name -match "Test" }
        
        if ($testProjects.Count -gt 0) {
          Write-Host "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:" -ForegroundColor Green
          $testProjects | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          foreach ($testProj in $testProjects) {
            Write-Host ""
            Write-Host "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º $($testProj.Name)..." -ForegroundColor Cyan
            
            # Unit —Ç–µ—Å—Ç—ã
            Write-Host "  üîπ Unit —Ç–µ—Å—Ç—ã..." -ForegroundColor Gray
            dotnet test $testProj.FullName --verbosity normal `
              --logger "trx;LogFileName=$($testProj.BaseName)-unit.trx" `
              --results-directory TestResults `
              --no-restore
            
            # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            Write-Host "  üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã..." -ForegroundColor Gray
            dotnet test $testProj.FullName --verbosity normal `
              --filter "Category=Integration" `
              --logger "trx;LogFileName=$($testProj.BaseName)-integration.trx" `
              --results-directory TestResults `
              --no-restore
          }
        } else {
          Write-Host "‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã" -ForegroundColor Yellow
          # –°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–∞
          "<TestRun></TestRun>" | Out-File -FilePath "TestResults/no-tests.trx"
        }
        
        Write-Host "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" -ForegroundColor Green

    - name: üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      shell: pwsh
      run: |
        Write-Host "üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã..." -ForegroundColor Green
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
        New-Item -ItemType Directory -Force -Path artifacts | Out-Null
        
        # 1. –ö–æ–ø–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É
        $buildDirs = Get-ChildItem -Recurse -Directory -Path "bin\Release\net8.0" -ErrorAction SilentlyContinue
        if ($buildDirs.Count -gt 0) {
          Write-Host "üì¶ –ö–æ–ø–∏—Ä—É–µ–º —Å–±–æ—Ä–∫—É..." -ForegroundColor Cyan
          foreach ($dir in $buildDirs) {
            $destDir = "artifacts\build\$($dir.Parent.Parent.Parent.Name)"
            New-Item -ItemType Directory -Force -Path $destDir | Out-Null
            Copy-Item -Path "$($dir.FullName)\*" -Destination $destDir -Recurse -Force
            Write-Host "  ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ $($dir.FullName)" -ForegroundColor Gray
          }
        }
        
        # 2. –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        if (Test-Path TestResults) {
          Write-Host "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤..." -ForegroundColor Cyan
          Copy-Item -Path TestResults\* -Destination artifacts\test-results -Recurse -Force
        }
        
        # 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
        Write-Host ""
        Write-Host "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ artifacts:" -ForegroundColor Cyan
        Get-ChildItem -Path artifacts -Recurse | ForEach-Object {
          $indent = "  " * ($_.FullName.Split('\').Length - $PWD.Path.Split('\').Length - 1)
          Write-Host "$indentüìÑ $($_.Name)" -ForegroundColor Gray
        }

    - name: üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –≤ GitHub
      uses: actions/upload-artifact@v4
      with:
        name: blog-api-artifacts
        path: artifacts/
        retention-days: 7

  # –î–∂–æ–±–∞ 2: –û—Ç—á–µ—Ç
  report:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: build-and-test
    runs-on: windows-latest
    if: always()

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      shell: pwsh
      run: |
        Write-Host "================================================================" -ForegroundColor Cyan
        Write-Host "              BLOG API –ü–ê–ô–ü–õ–ê–ù –ó–ê–í–ï–†–®–ï–ù! üéâ" -ForegroundColor Green
        Write-Host "================================================================" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–´–ü–û–õ–ù–ï–ù–ò–Ø:" -ForegroundColor Yellow
        Write-Host "  ‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ - ${{ needs.build-and-test.result }}" -ForegroundColor $(if ('${{ needs.build-and-test.result }}' -eq 'success') { 'Green' } else { 'Red' })
        Write-Host ""
        Write-Host "üîß –ò–ù–§–û–†–ú–ê–¶–ò–Ø:" -ForegroundColor Yellow
        Write-Host "  ‚Ä¢ –í–µ—Ç–∫–∞: ${{ github.ref }}" -ForegroundColor Gray
        Write-Host "  ‚Ä¢ –ö–æ–º–º–∏—Ç: ${{ github.sha }}" -ForegroundColor Gray
        Write-Host "  ‚Ä¢ –ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä: ${{ github.actor }}" -ForegroundColor Gray
        Write-Host "  ‚Ä¢ –°–∏—Å—Ç–µ–º–∞: Windows" -ForegroundColor Gray
        Write-Host ""
        Write-Host "üïê –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ForegroundColor Gray
        Write-Host ""
        
        if ('${{ needs.build-and-test.result }}' -eq 'success') {
          Write-Host "üéâ –í–°–ï –≠–¢–ê–ü–´ –í–´–ü–û–õ–ù–ï–ù–´ –£–°–ü–ï–®–ù–û!" -ForegroundColor Green
          Write-Host "üì¶ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è" -ForegroundColor Cyan
        } else {
          Write-Host "‚ùå –í–´–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–í–ï–†–®–ò–õ–û–°–¨ –° –û–®–ò–ë–ö–û–ô" -ForegroundColor Red
          Write-Host "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è" -ForegroundColor Yellow
        }
        
        Write-Host "================================================================" -ForegroundColor Cyan